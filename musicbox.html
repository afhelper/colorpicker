<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보안 로그인</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-10">

    <div id="logoutSection" class="w-full max-w-md mb-4 text-right hidden">
        <button id="logoutButton"
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 text-sm rounded-md shadow-sm transition duration-150 ease-in-out">
            로그아웃
        </button>
    </div>

    <div id="loginFormContainer" class="bg-white p-8 rounded-lg shadow-md w-full max-w-xs mb-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">로그인</h2>

        <div class="mb-4">
            <label for="password" class="block text-sm font-medium text-gray-600 mb-1">비밀번호</label>
            <input type="password" id="password" name="password"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="비밀번호를 입력하세요">
        </div>

        <div class="mb-4 flex justify-center">
            <div class="g-recaptcha" data-sitekey="6Lc8aVErAAAAAMNjQG951806Wy0TY7zGB2rbDZig"></div>
        </div>

        <button id="loginButton"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            로그인
        </button>

        <div id="message" class="mt-4 text-sm text-center"></div>
    </div>

    <div id="dataSection" class="bg-white p-6 rounded-lg shadow-md w-full max-w-md hidden">
        <h3 class="text-xl font-semibold mb-3 text-gray-700">인증된 사용자를 위한 데이터</h3>
        <pre id="jsonDataContainer" class="bg-gray-50 p-3 rounded text-sm overflow-x-auto"></pre>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        console.log("Firebase 모듈 임포트 완료");

        const firebaseConfig = {
            apiKey: "AIzaSyBeIPr1H_de7eIZUagNAUvPbw-rYRteP9U",
            authDomain: "submit-33eb1.firebaseapp.com",
            projectId: "submit-33eb1",
            storageBucket: "submit-33eb1.appspot.com",
            messagingSenderId: "123176179541",
            appId: "1:123176179541:web:c40f2392c8b95fb93601dc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        console.log("Firebase 초기화 완료");

        const loginFormContainer = document.getElementById('loginFormContainer');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const messageDiv = document.getElementById('message');

        const dataSectionDiv = document.getElementById('dataSection');
        const jsonDataContainer = document.getElementById('jsonDataContainer');
        const logoutSectionDiv = document.getElementById('logoutSection');
        const logoutButton = document.getElementById('logoutButton');

        const FIXED_EMAIL = "admin@admin.com";

        // UI 업데이트 함수
        function updateUI(user) {
            if (user) { // 로그인 상태
                loginFormContainer.classList.add('hidden');
                logoutSectionDiv.classList.remove('hidden');
                dataSectionDiv.classList.remove('hidden');
                loadAndDisplayDummyData(); // 데이터 로드 및 표시
            } else { // 로그아웃 상태
                loginFormContainer.classList.remove('hidden');
                logoutSectionDiv.classList.add('hidden');
                dataSectionDiv.classList.add('hidden');
                jsonDataContainer.textContent = ''; // 기존 데이터 지우기
                messageDiv.textContent = ''; // 메시지 지우기
                if (typeof grecaptcha !== 'undefined') { // reCAPTCHA 리셋
                    grecaptcha.reset();
                }
            }
        }

        // 인증 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            updateUI(user);
            if (user) {
                console.log("로그인 상태:", user.email);
            } else {
                console.log("로그아웃 상태");
            }
        });

        async function fetchDummyData() {
            // ... (이전과 동일한 fetchDummyData 함수)
            return new Promise(resolve => {
                setTimeout(() => {
                    const dummyData = {
                        userProfile: {
                            username: "admin_user",
                            email: FIXED_EMAIL,
                            preferences: { theme: "dark", notifications: true },
                            lastLogin: new Date().toISOString()
                        },
                        musicList: [
                            { "id": "song001", "title": "별빛 교향곡", "artist": "우주먼지" },
                            { "id": "song002", "title": "코딩하는 밤", "artist": "카페인" },
                            { "id": "song003", "title": "새벽의 알고리즘", "artist": "AI सिंगर" }
                        ],
                        message: "데이터 로드 성공!"
                    };
                    resolve(dummyData);
                }, 300);
            });
        }

        async function loadAndDisplayDummyData() {
            try {
                const jsonData = await fetchDummyData();
                console.log("가져온 JSON 데이터:", jsonData);
                jsonDataContainer.textContent = JSON.stringify(jsonData, null, 2);
            } catch (error) {
                console.error("더미 데이터 로드 실패:", error);
                jsonDataContainer.textContent = "데이터를 불러오는 데 실패했습니다.";
            }
        }

        // 로그인 처리 함수
        async function handleLogin() {
            const password = passwordInput.value;
            const recaptchaResponse = (typeof grecaptcha !== 'undefined') ? grecaptcha.getResponse() : 'test_mode'; // reCAPTCHA 로드 안됐을때 테스트용

            if (!password) {
                messageDiv.textContent = "비밀번호를 입력해주세요.";
                messageDiv.className = "mt-4 text-sm text-center text-red-500";
                return;
            }

            if (!recaptchaResponse) { // reCAPTCHA 응답이 없으면
                messageDiv.textContent = "reCAPTCHA를 완료해주세요.";
                messageDiv.className = "mt-4 text-sm text-center text-red-500";
                return;
            }

            loginButton.disabled = true;
            loginButton.textContent = "로그인 중...";
            loginButton.classList.add("opacity-50", "cursor-not-allowed");
            messageDiv.textContent = "로그인 시도 중...";
            messageDiv.className = "mt-4 text-sm text-center text-gray-500";

            try {
                await signInWithEmailAndPassword(auth, FIXED_EMAIL, password);
                // 성공 메시지는 onAuthStateChanged 에서 UI 업데이트로 처리됨
                // passwordInput.value = ""; // 입력 필드 초기화는 성공 시 UI 업데이트 함수에서 해도 됨
            } catch (error) {
                console.error("로그인 실패:", error.code, error.message);
                messageDiv.textContent = "로그인 실패: " + mapAuthError(error.code);
                messageDiv.className = "mt-4 text-sm text-center text-red-600";
                if (typeof grecaptcha !== 'undefined') { // 실패 시 reCAPTCHA 리셋
                    grecaptcha.reset();
                }
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = "로그인";
                loginButton.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }

        loginButton.addEventListener('click', handleLogin);

        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // 폼 자동 제출 방지 (혹시 모를 상황 대비)
                handleLogin();
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // 로그아웃 성공 시 UI는 onAuthStateChanged가 알아서 처리
            } catch (error) {
                console.error("로그아웃 실패:", error);
                // 필요하다면 사용자에게 알림
            }
        });

        function mapAuthError(errorCode) {
            // ... (이전과 동일한 에러 매핑 함수)
            switch (errorCode) {
                case "auth/invalid-email": return "잘못된 이메일 형식입니다.";
                case "auth/user-disabled": return "사용 중지된 계정입니다.";
                case "auth/user-not-found": case "auth/wrong-password": case "auth/invalid-credential":
                    return "비밀번호가 올바르지 않습니다.";
                case "auth/too-many-requests": return "너무 많은 요청이 있었습니다. 잠시 후 다시 시도해주세요.";
                case "auth/network-request-failed": return "네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.";
                case "auth/captcha-check-failed": return "reCAPTCHA 인증에 실패했습니다."; // App Check 등과 연동 시
                default: return "알 수 없는 오류가 발생했습니다. (" + errorCode + ")";
            }
        }
    </script>
</body>

</html>